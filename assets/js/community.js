const auth=firebase.auth();var db=firebase.firestore();function openLogin(){isApp()?(location.href="https://ssoak-72f93.firebaseapp.com/",$(".sheet-backdrop-nocancel").addClass("backdrop-in"),$("#login-loader").show()):($(".sheet-backdrop-nocancel").addClass("backdrop-in"),$("#login-loader").show(),loginGoogle().then((function(e){console.log("구글 로그인 완료",e),$(".sheet-backdrop-nocancel").removeClass("backdrop-in"),$("#login-loader").hide()})))}firebase.auth().onAuthStateChanged((function(e){e?(loadPostList(),$("#community .no-login").hide(),$("#community .main-community").show(),$("#community #account-btn").show(),$("#community .header").show(),Android.sendUserIdForFCM(firebase.auth().currentUser.uid)):($("#community .no-login").show(),$("#community .main-community").hide(),$("#community #account-btn").hide(),$("#community .header").hide())}));var tempData=[];const provider=new firebase.auth.GoogleAuthProvider,loginGoogle=()=>firebase.auth().signInWithPopup(provider).then((e=>{if($(".sheet-backdrop-nocancel").removeClass("backdrop-in"),$("#login-loader").hide(),e.additionalUserInfo.isNewUser){(tempData=[])[0]=e.user.uid,tempData[1]=e.user.email,tempData[2]=e.user.displayName;var t={uid:tempData[0],email:tempData[1],nickname:e.user.displayName,admin:!1};db.collection("users").doc(tempData[0]).set(t).then((e=>{console.log("계정정보 1차 저장 완료")})).catch((e=>{console.log(e)})),$("#login-username").val(e.user.displayName),$(".sheet-modal").css("height","30%"),$("#modal-title").html("시작하기"),$(".content-wrap").hide(),$("#loginForm").show(),$("#exam").hide(),$("#assign-add-save-btn").hide(),$("#assign-edit-save-btn").hide(),$("body").css("overflow","hidden"),$(".modal-in").css("display","block"),$(".modal-in").css("bottom","-1850px"),setTimeout((function(){$(".modal-in").css("bottom","0px")}),100),$(".sheet-backdrop-nocancel").addClass("backdrop-in"),$(".sheet-backdrop").removeClass("backdrop-in"),setTimeout((function(){$(".sheet-modal").css("height",$("#loginForm").height()+130+"px")}),100)}})).catch((e=>{$(".sheet-backdrop-nocancel").removeClass("backdrop-in"),$("#login-loader").hide(),console.log(e.message),"The popup has been closed by the user before finalizing the operation."==e.message||"The user has cancelled authentication."==e.message?toast("로그인이 취소되었습니다."):toast("로그인 에러 : "+e.message)}));function finishGoogleLogin(e){e.uid?$("#community #account-btn").show():Swal.fire({icon:"error",title:"오류",text:"계정이 정상적으로 생성되지 않았습니다. 다시 시도해주세요."})}function pushWebviewGoogleLoginToken(e){const t=firebase.auth.GoogleAuthProvider.credential(e);firebase.auth().signInWithCredential(t).then((e=>{if($(".sheet-backdrop-nocancel").removeClass("backdrop-in"),$("#login-loader").hide(),e.additionalUserInfo.isNewUser){(tempData=[])[0]=e.user.uid,tempData[1]=e.user.email,tempData[2]=e.user.displayName;var t={uid:tempData[0],email:tempData[1],nickname:e.user.displayName,admin:!1};db.collection("users").doc(tempData[0]).set(t).then((e=>{console.log("계정정보 1차 저장 완료")})).catch((e=>{console.log(e)})),$("#login-username").val(e.user.displayName),$(".sheet-modal").css("height","30%"),$("#modal-title").html("시작하기"),$(".content-wrap").hide(),$("#loginForm").show(),$("#exam").hide(),$("#assign-add-save-btn").hide(),$("#assign-edit-save-btn").hide(),$("body").css("overflow","hidden"),$(".modal-in").css("display","block"),$(".modal-in").css("bottom","-1850px"),setTimeout((function(){$(".modal-in").css("bottom","0px")}),100),$(".sheet-backdrop-nocancel").addClass("backdrop-in"),$(".sheet-backdrop").removeClass("backdrop-in"),setTimeout((function(){$(".sheet-modal").css("height",$("#loginForm").height()+130+"px")}),100)}})).catch((t=>{console.log(t);const o=t.code,i=t.message;logError(`Error logging in: ${o} ${i} token: ${e}`,t)}))}async function confirmLogout(){await ui.confirm("정말 로그아웃 하시겠습니까?")&&firebase.auth().signOut().then((function(){$("#community #account-btn").hide(),$("#community .no-login").show(),closeModal(),toast("로그아웃 되었습니다."),Android.logoutAndroidApp()}))}function edit_saveAccountDb(){var e=$("#account-username").val();if(""==e||" "==e||null==e||null==e||"  "==e)toast("닉네임을 입력해주세요.");else{$("body").css("overflow","auto"),$(".modal-in").css("bottom","-1850px"),setTimeout((function(){$(".modal-in").css("display","none")}),100),$(".sheet-backdrop").removeClass("backdrop-in");var t={nickname:$("#account-username").val()};db.collection("users").doc(firebase.auth().currentUser.uid).update(t).then((e=>{loadPostList()})).catch((e=>{toast(e),console.log(e)}))}}function saveAccountDb(){var e=$("#login-username").val(),t=$("#signup-checklist input:checked").map((function(){return this.value})).get();if(""==e||" "==e||null==e||null==e||"  "==e)toast("닉네임을 입력해주세요.");else if(3!=t.length)toast("모든 항목에 동의해주세요.");else{$("body").css("overflow","auto"),$(".modal-in").css("bottom","-1850px"),setTimeout((function(){$(".modal-in").css("display","none")}),100),$(".sheet-backdrop-nocancel").removeClass("backdrop-in");var o={nickname:$("#login-username").val()};db.collection("users").doc(firebase.auth().currentUser.uid).update(o).then((e=>{$("#community #account-btn").show()})).catch((e=>{toast(e),console.log(e)}))}}$("#community #account-btn").on("click",(function(){$(".sheet-modal").css("height","30%"),$("#modal-title").html("계정 설정"),$(".content-wrap").hide(),$("#account").show(),$("#exam").hide(),$("#assign-add-save-btn").hide(),$("#assign-edit-save-btn").hide(),$("body").css("overflow","hidden"),$(".modal-in").css("display","block"),$(".modal-in").css("bottom","-1850px"),db.collection("users").doc(firebase.auth().currentUser.uid).get().then((e=>{var t=e.data();$("#account-username").val(t.nickname)})),setTimeout((function(){$(".modal-in").css("bottom","0px")}),100),$(".sheet-backdrop").addClass("backdrop-in"),setTimeout((function(){$(".sheet-modal").css("height",$("#account").height()+130+"px")}),100)})),$("#account #logout-btn").on("click",(function(){confirmLogout()}));var lastVisible,editor=new toastui.Editor.factory({el:document.querySelector("#editor"),initialEditType:"wysiwyg",height:"40vh",initialValue:"",language:"ko_KR",theme:"default",autofocus:!1});function post(e){var t=$("#post-title").val(),o=editor.getMarkdown(),i=firebase.auth().currentUser.uid;if(o){var a=firebase.firestore.Timestamp.fromDate(new Date);$(e).text("업로드 중...");var n={title:t,userId:i,content:o,category:"자유",createdAt:a};db.collection("board").add(n).then((t=>{closeModal(),$(e).text("등록"),openPost("board.html?id="+t._key.path.segments[1])})).catch((e=>{console.log(e)})),$(".snackbar").hide(),loadPostList()}else toast("게시글 내용을 작성해주세요.")}$(".writePost-btn").on("click",(function(){$(".sheet-modal").css("height","30%"),$("#modal-title").html("게시글 작성"),$(".content-wrap").hide(),$("#writePost").show(),$("#exam").hide(),$("#assign-add-save-btn").hide(),$("#assign-edit-save-btn").hide(),$("body").css("overflow","hidden"),$(".modal-in").css("display","block"),$(".modal-in").css("bottom","-1850px"),$("#editor").empty(),editor="true"==storedTheme||"system"==storedTheme&&mql.matches?new toastui.Editor.factory({el:document.querySelector("#editor"),initialEditType:"wysiwyg",height:"40vh",initialValue:"",language:"ko_KR",theme:"dark",autofocus:!1}):new toastui.Editor.factory({el:document.querySelector("#editor"),initialEditType:"wysiwyg",initialValue:"",height:"40vh",language:"ko_KR",autofocus:!1}),setTimeout((function(){$(".modal-in").css("bottom","0px")}),100),$(".sheet-backdrop").addClass("backdrop-in"),setTimeout((function(){$(".sheet-modal").css("height",$("#writePost").height()+200+"px")}),100)}));var isFirstLoad=!0;function loadPostList(){db.collection("board").orderBy("createdAt").limitToLast(4).get().then((e=>{$(".post-listview").html(""),e.forEach((t=>{var o=t.data();lastVisible=e.docs[3-(e.docs.length-1)],db.collection("users").doc(o.userId).get().then((e=>{var i=e.data();if($(".post-listview").prepend('\n                        <div class="post-item" onclick="openPost(\'board.html?id='+t.id+'\', this);" data-createdAt="'+o.createdAt.toDate().getTime()+'">\n                        <div class="post-header">\n                            <span id="uname">'+(i.admin?i.nickname+' <ion-icon class="admin-badge" name="checkmark-circle"></ion-icon>':i.nickname)+'<br>\n                                <span style="opacity:0.7">'+timeForToday(o.createdAt.toDate())+'</span>\n                            </span>\n        \n                        </div>\n        \n                        <h3 id="post-title">'+o.title+'</h3>\n        \n                        <div class="post-preview" id="viewer-'+t.id+'">\n                        </div>\n    \n                        <span style="color:#5272ff;font-size:15px;margin-top:10px;">더보기</span>\n                        <br>\n        \n                        </div>\n                        '),"true"==storedTheme||"system"==storedTheme&&mql.matches){new toastui.Editor.factory({el:document.querySelector("#viewer-"+t.id),viewer:!0,initialValue:o.content.replace(/(?:__|[*#])|\[(.*?)\]\(.*?\)/gm,"$1"),theme:"dark"});$(".post-item").addClass("dark")}else{new toastui.Editor.factory({el:document.querySelector("#viewer-"+t.id),viewer:!0,initialValue:o.content.replace(/(?:__|[*#])|\[(.*?)\]\(.*?\)/gm,"$1"),theme:"default"})}$(".post-item").sort((function(e,t){return $(t).data("createdat")-$(e).data("createdat")})).appendTo(".post-listview")})),isFirstLoad=!1}))}))}function loadMore(){lastVisible?(db.collection("board").orderBy("createdAt").limitToLast(4).endBefore(lastVisible).get().then((e=>{e.forEach((t=>{var o=t.data();lastVisible=e.docs[3-(e.docs.length=1)],db.collection("users").doc(o.userId).get().then((e=>{var i=e.data();if($(".post-listview").prepend('\n                            <div class="post-item" onclick="openPost(\'board.html?id='+t.id+'\', this);" data-createdAt="'+o.createdAt.toDate().getTime()+'">\n                            <div class="post-header">\n                                <span id="uname">'+(i.admin?i.nickname+' <ion-icon class="admin-badge" name="checkmark-circle"></ion-icon>':i.nickname)+'<br>\n                                    <span style="opacity:0.7">'+timeForToday(o.createdAt.toDate())+'</span>\n                                </span>\n            \n                            </div>\n            \n                            <h3 id="post-title">'+o.title+'</h3>\n            \n                            <div class="post-preview" id="viewer-'+t.id+'">\n                            </div>\n        \n                            <span style="color:#5272ff;font-size:15px;margin-top:10px;">더보기</span>\n                            <br>\n            \n                            </div>\n                            '),"true"==storedTheme||"system"==storedTheme&&mql.matches){new toastui.Editor.factory({el:document.querySelector("#viewer-"+t.id),viewer:!0,initialValue:o.content.replace(/(?:__|[*#])|\[(.*?)\]\(.*?\)/gm,"$1"),theme:"dark"});$(".post-item").addClass("dark")}else{new toastui.Editor.factory({el:document.querySelector("#viewer-"+t.id),viewer:!0,initialValue:o.content.replace(/(?:__|[*#])|\[(.*?)\]\(.*?\)/gm,"$1"),theme:"default"})}$(".post-item").sort((function(e,t){return $(t).data("createdat")-$(e).data("createdat")})).appendTo(".post-listview")}))}))})),$(".bottom_postList").html("")):$(".bottom_postList").html("마지막 글입니다.")}const Element=document.querySelector(".bottom_postList"),options={},io=new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&$(".post-listview").html().length>5&&loadMore()}))}),options);function openPost(e,t){isApp()?location.href=e:window.open(e,"_blank")}function timeForToday(e){const t=new Date,o=new Date(e),i=Math.floor((t.getTime()-o.getTime())/1e3/60);if(i<1)return"방금 전";if(i<60)return`${i}분 전`;const a=Math.floor(i/60);if(a<24)return`${a}시간 전`;const n=Math.floor(i/60/24);return n<365?n>30?`${Math.floor(n/30)}개월 전`:`${n}일 전`:`${Math.floor(n/365)}년 전`}io.observe(Element);var originalSize=jQuery(window).width()+jQuery(window).height();$(window).resize((function(){jQuery(window).width()+jQuery(window).height()!=originalSize&&$("#writePost").is(":visible")?$(".sheet-modal").addClass("full-modal"):$(".sheet-modal").removeClass("full-modal")})),$(document).on("focusout","input",(function(){$(".sheet-modal").removeClass("full-modal")}));